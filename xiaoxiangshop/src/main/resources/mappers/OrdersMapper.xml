<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.xiaoxiangshop.demos.dao.IOrdersDao">

    <resultMap id="map1" type="orders">
        <id property="order_id" column="order_id"/>
        <result property="user_id" column="user_id"/>
        <result property="ride_id" column="ride_id"/>
        <result property="order_status_id" column="order_status_id"/>
        <result property="start_time" column="start_time"/>
        <result property="end_time" column="end_time"/>
        <result property="total_amount" column="total_amount"/>
        <result property="user_note" column="user_note"/>
        <result property="pay_method" column="pay_method"/>
        <result property="distance" column="distance"/>
        <result property="price" column="price"/>
        <association property="user_addresses" column="user_id" javaType="user_addresses" select="selectUserAddress"/>

    </resultMap>
    <select id="selectUserAddress" resultType="user_addresses">
        select * from user_addresses where user_id=#{user_id} and default_address=1
    </select>
    <select id="ordersList" resultMap="map1">
        select * from orders where order_status_id=4
    </select>
    <update id="ordersPick" parameterType="int">
        update orders set order_status_id=5 where order_id=#{order_id}
    </update>
    <update id="ordersSend" parameterType="int">
        update orders set order_status_id=6 where order_id=#{order_id}
    </update>
    <update id="overOrders" parameterType="int">
        update orders set order_status_id=7 where order_id=#{order_id}
    </update>
    <update id="price" parameterType="double">
        update orders set price=#{m} where order_id=#{order_id}
    </update>
    <select id="pendingList" resultMap="map1">
        select * from orders where order_status_id=5
    </select>
    <select id="endList" resultMap="map1">
        select * from orders where order_status_id=6
    </select>
    <select id="overList" resultMap="map1">
        select * from orders where order_status_id=7
    </select>
    <resultMap id="orderWithProductsResultMap" type="orders">
        <id column="order_id" property="order_id" />
        <result column="user_id" property="user_id" />
        <result column="ride_id" property="ride_id" />
        <result column="order_status_id" property="order_status_id" />
        <result column="start_time" property="start_time" />
        <result column="end_time" property="end_time" />
        <result column="total_amount" property="total_amount" />
        <result column="user_note" property="user_note" />
        <result column="pay_method" property="pay_method" />
        <result column="distance" property="distance" />

        <!-- 订单详情 -->
        <collection property="orderDetails" ofType="order_details">
            <id column="order_detail_id" property="order_detail_id" />
            <result column="order_id" property="order_id" />
            <result column="product_id" property="product_id" />
            <result column="quantity" property="quantity" />
            <result column="unit_price" property="unit_price" />
            <result column="total_price" property="total_price" />

            <!-- 产品 -->
            <association property="products" javaType="products">
                <id column="product_id" property="product_id" />
                <result column="product_name" property="product_name" />
                <result column="description" property="description" />
                <result column="price" property="price" />
                <!-- 更多产品属性 -->
            </association>
        </collection>
    </resultMap>

    <select id="findOrdersWithProducts" resultMap="orderWithProductsResultMap">
        SELECT o.*, od.*, p.*
        FROM orders o
                 LEFT JOIN order_details od ON o.order_id = od.order_id
                 LEFT JOIN products p ON od.product_id = p.product_id
        where o.order_id in (select order_id from orders where user_id = #{userid})
    </select>

    <select id="findOrdersByUserId" resultType="orders">
        select * from orders where user_id=#{UserId}
    </select>
    <select id="findOrdersByUserIdandstatus" resultType="orders">
        select * from orders where user_id=#{UserId} and order_status_id=#{Status}
    </select>

    <delete id="deleteOrderByOrderId">
        DELETE FROM orders WHERE order_id = #{orderId}
    </delete>
</mapper>
